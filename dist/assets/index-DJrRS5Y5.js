(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();function Ke(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Ve(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var n=function s(){var i=!1;try{i=this instanceof s}catch{}return i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach(function(s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(n,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}),n}var Z={exports:{}},Fe=Z.exports,we;function je(){return we||(we=1,(function(e){(function(t,n,s){function i(r){var l=this,d=o();l.next=function(){var u=2091639*l.s0+l.c*23283064365386963e-26;return l.s0=l.s1,l.s1=l.s2,l.s2=u-(l.c=u|0)},l.c=1,l.s0=d(" "),l.s1=d(" "),l.s2=d(" "),l.s0-=d(r),l.s0<0&&(l.s0+=1),l.s1-=d(r),l.s1<0&&(l.s1+=1),l.s2-=d(r),l.s2<0&&(l.s2+=1),d=null}function a(r,l){return l.c=r.c,l.s0=r.s0,l.s1=r.s1,l.s2=r.s2,l}function c(r,l){var d=new i(r),u=l&&l.state,p=d.next;return p.int32=function(){return d.next()*4294967296|0},p.double=function(){return p()+(p()*2097152|0)*11102230246251565e-32},p.quick=p,u&&(typeof u=="object"&&a(u,d),p.state=function(){return a(d,{})}),p}function o(){var r=4022871197,l=function(d){d=String(d);for(var u=0;u<d.length;u++){r+=d.charCodeAt(u);var p=.02519603282416938*r;r=p>>>0,p-=r,p*=r,r=p>>>0,p-=r,r+=p*4294967296}return(r>>>0)*23283064365386963e-26};return l}n&&n.exports?n.exports=c:this.alea=c})(Fe,e)})(Z)),Z.exports}var ee={exports:{}},He=ee.exports,Se;function We(){return Se||(Se=1,(function(e){(function(t,n,s){function i(o){var r=this,l="";r.x=0,r.y=0,r.z=0,r.w=0,r.next=function(){var u=r.x^r.x<<11;return r.x=r.y,r.y=r.z,r.z=r.w,r.w^=r.w>>>19^u^u>>>8},o===(o|0)?r.x=o:l+=o;for(var d=0;d<l.length+64;d++)r.x^=l.charCodeAt(d)|0,r.next()}function a(o,r){return r.x=o.x,r.y=o.y,r.z=o.z,r.w=o.w,r}function c(o,r){var l=new i(o),d=r&&r.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var p=l.next()>>>11,f=(l.next()>>>0)/4294967296,h=(p+f)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,d&&(typeof d=="object"&&a(d,l),u.state=function(){return a(l,{})}),u}n&&n.exports?n.exports=c:this.xor128=c})(He,e)})(ee)),ee.exports}var te={exports:{}},Ue=te.exports,$e;function Xe(){return $e||($e=1,(function(e){(function(t,n,s){function i(o){var r=this,l="";r.next=function(){var u=r.x^r.x>>>2;return r.x=r.y,r.y=r.z,r.z=r.w,r.w=r.v,(r.d=r.d+362437|0)+(r.v=r.v^r.v<<4^(u^u<<1))|0},r.x=0,r.y=0,r.z=0,r.w=0,r.v=0,o===(o|0)?r.x=o:l+=o;for(var d=0;d<l.length+64;d++)r.x^=l.charCodeAt(d)|0,d==l.length&&(r.d=r.x<<10^r.x>>>4),r.next()}function a(o,r){return r.x=o.x,r.y=o.y,r.z=o.z,r.w=o.w,r.v=o.v,r.d=o.d,r}function c(o,r){var l=new i(o),d=r&&r.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var p=l.next()>>>11,f=(l.next()>>>0)/4294967296,h=(p+f)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,d&&(typeof d=="object"&&a(d,l),u.state=function(){return a(l,{})}),u}n&&n.exports?n.exports=c:this.xorwow=c})(Ue,e)})(te)),te.exports}var ne={exports:{}},Ye=ne.exports,Ee;function Je(){return Ee||(Ee=1,(function(e){(function(t,n,s){function i(o){var r=this;r.next=function(){var d=r.x,u=r.i,p,f;return p=d[u],p^=p>>>7,f=p^p<<24,p=d[u+1&7],f^=p^p>>>10,p=d[u+3&7],f^=p^p>>>3,p=d[u+4&7],f^=p^p<<7,p=d[u+7&7],p=p^p<<13,f^=p^p<<9,d[u]=f,r.i=u+1&7,f};function l(d,u){var p,f=[];if(u===(u|0))f[0]=u;else for(u=""+u,p=0;p<u.length;++p)f[p&7]=f[p&7]<<15^u.charCodeAt(p)+f[p+1&7]<<13;for(;f.length<8;)f.push(0);for(p=0;p<8&&f[p]===0;++p);for(p==8?f[7]=-1:f[p],d.x=f,d.i=0,p=256;p>0;--p)d.next()}l(r,o)}function a(o,r){return r.x=o.x.slice(),r.i=o.i,r}function c(o,r){o==null&&(o=+new Date);var l=new i(o),d=r&&r.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var p=l.next()>>>11,f=(l.next()>>>0)/4294967296,h=(p+f)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,d&&(d.x&&a(d,l),u.state=function(){return a(l,{})}),u}n&&n.exports?n.exports=c:this.xorshift7=c})(Ye,e)})(ne)),ne.exports}var ie={exports:{}},Qe=ie.exports,ke;function Ze(){return ke||(ke=1,(function(e){(function(t,n,s){function i(o){var r=this;r.next=function(){var d=r.w,u=r.X,p=r.i,f,h;return r.w=d=d+1640531527|0,h=u[p+34&127],f=u[p=p+1&127],h^=h<<13,f^=f<<17,h^=h>>>15,f^=f>>>12,h=u[p]=h^f,r.i=p,h+(d^d>>>16)|0};function l(d,u){var p,f,h,v,w,S=[],A=128;for(u===(u|0)?(f=u,u=null):(u=u+"\0",f=0,A=Math.max(A,u.length)),h=0,v=-32;v<A;++v)u&&(f^=u.charCodeAt((v+32)%u.length)),v===0&&(w=f),f^=f<<10,f^=f>>>15,f^=f<<4,f^=f>>>13,v>=0&&(w=w+1640531527|0,p=S[v&127]^=f+w,h=p==0?h+1:0);for(h>=128&&(S[(u&&u.length||0)&127]=-1),h=127,v=512;v>0;--v)f=S[h+34&127],p=S[h=h+1&127],f^=f<<13,p^=p<<17,f^=f>>>15,p^=p>>>12,S[h]=f^p;d.w=w,d.X=S,d.i=h}l(r,o)}function a(o,r){return r.i=o.i,r.w=o.w,r.X=o.X.slice(),r}function c(o,r){o==null&&(o=+new Date);var l=new i(o),d=r&&r.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var p=l.next()>>>11,f=(l.next()>>>0)/4294967296,h=(p+f)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,d&&(d.X&&a(d,l),u.state=function(){return a(l,{})}),u}n&&n.exports?n.exports=c:this.xor4096=c})(Qe,e)})(ie)),ie.exports}var se={exports:{}},et=se.exports,Ae;function tt(){return Ae||(Ae=1,(function(e){(function(t,n,s){function i(o){var r=this,l="";r.next=function(){var u=r.b,p=r.c,f=r.d,h=r.a;return u=u<<25^u>>>7^p,p=p-f|0,f=f<<24^f>>>8^h,h=h-u|0,r.b=u=u<<20^u>>>12^p,r.c=p=p-f|0,r.d=f<<16^p>>>16^h,r.a=h-u|0},r.a=0,r.b=0,r.c=-1640531527,r.d=1367130551,o===Math.floor(o)?(r.a=o/4294967296|0,r.b=o|0):l+=o;for(var d=0;d<l.length+20;d++)r.b^=l.charCodeAt(d)|0,r.next()}function a(o,r){return r.a=o.a,r.b=o.b,r.c=o.c,r.d=o.d,r}function c(o,r){var l=new i(o),d=r&&r.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var p=l.next()>>>11,f=(l.next()>>>0)/4294967296,h=(p+f)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,d&&(typeof d=="object"&&a(d,l),u.state=function(){return a(l,{})}),u}n&&n.exports?n.exports=c:this.tychei=c})(et,e)})(se)),se.exports}var re={exports:{}};const nt={},it=Object.freeze(Object.defineProperty({__proto__:null,default:nt},Symbol.toStringTag,{value:"Module"})),st=Ve(it);var rt=re.exports,Ie;function ot(){return Ie||(Ie=1,(function(e){(function(t,n,s){var i=256,a=6,c=52,o="random",r=s.pow(i,a),l=s.pow(2,c),d=l*2,u=i-1,p;function f(y,$,C){var x=[];$=$==!0?{entropy:!0}:$||{};var T=S(w($.entropy?[y,L(n)]:y??A(),3),x),R=new h(x),O=function(){for(var B=R.g(a),_=r,q=0;B<l;)B=(B+q)*i,_*=i,q=R.g(1);for(;B>=d;)B/=2,_/=2,q>>>=1;return(B+q)/_};return O.int32=function(){return R.g(4)|0},O.quick=function(){return R.g(4)/4294967296},O.double=O,S(L(R.S),n),($.pass||C||function(B,_,q,K){return K&&(K.S&&v(K,R),B.state=function(){return v(R,{})}),q?(s[o]=B,_):B})(O,T,"global"in $?$.global:this==s,$.state)}function h(y){var $,C=y.length,x=this,T=0,R=x.i=x.j=0,O=x.S=[];for(C||(y=[C++]);T<i;)O[T]=T++;for(T=0;T<i;T++)O[T]=O[R=u&R+y[T%C]+($=O[T])],O[R]=$;(x.g=function(B){for(var _,q=0,K=x.i,J=x.j,U=x.S;B--;)_=U[K=u&K+1],q=q*i+U[u&(U[K]=U[J=u&J+_])+(U[J]=_)];return x.i=K,x.j=J,q})(i)}function v(y,$){return $.i=y.i,$.j=y.j,$.S=y.S.slice(),$}function w(y,$){var C=[],x=typeof y,T;if($&&x=="object")for(T in y)try{C.push(w(y[T],$-1))}catch{}return C.length?C:x=="string"?y:y+"\0"}function S(y,$){for(var C=y+"",x,T=0;T<C.length;)$[u&T]=u&(x^=$[u&T]*19)+C.charCodeAt(T++);return L($)}function A(){try{var y;return p&&(y=p.randomBytes)?y=y(i):(y=new Uint8Array(i),(t.crypto||t.msCrypto).getRandomValues(y)),L(y)}catch{var $=t.navigator,C=$&&$.plugins;return[+new Date,t,C,t.screen,L(n)]}}function L(y){return String.fromCharCode.apply(0,y)}if(S(s.random(),n),e.exports){e.exports=f;try{p=st}catch{}}else s["seed"+o]=f})(typeof self<"u"?self:rt,[],Math)})(re)),re.exports}var ue,Te;function at(){if(Te)return ue;Te=1;var e=je(),t=We(),n=Xe(),s=Je(),i=Ze(),a=tt(),c=ot();return c.alea=e,c.xor128=t,c.xorwow=n,c.xorshift7=s,c.xor4096=i,c.tychei=a,ue=c,ue}var ct=at();const lt=Ke(ct);function Ne(e){const t=lt(e);return{random(){return t()},randomInt(n,s){return Math.floor(t()*(s-n+1))+n},pick(n){const s=Math.floor(t()*n.length);return n[s]},shuffle(n){const s=[...n];for(let i=s.length-1;i>0;i--){const a=Math.floor(t()*(i+1));[s[i],s[a]]=[s[a],s[i]]}return s},weightedPick(n,s){const i=s.reduce((c,o)=>c+o,0);let a=t()*i;for(let c=0;c<n.length;c++)if(a-=s[c],a<=0)return n[c];return n[n.length-1]},getSeed(){return e}}}function fe(e){return Object.freeze({id:e.id,firstName:e.firstName,lastName:e.lastName,occupation:e.occupation,age:e.age,description:e.description,personality:Object.freeze({...e.personality}),isVictim:e.isVictim??!1,isKiller:e.isKiller??!1})}function D(e){return`${e.firstName} ${e.lastName}`}var g=(e=>(e.Spouse="spouse",e.ExSpouse="ex_spouse",e.Lover="lover",e.ExLover="ex_lover",e.Sibling="sibling",e.Parent="parent",e.Child="child",e.Friend="friend",e.Rival="rival",e.Enemy="enemy",e.BusinessPartner="business_partner",e.Employee="employee",e.Employer="employer",e.Acquaintance="acquaintance",e))(g||{}),k=(e=>(e.Jealousy="jealousy",e.Greed="greed",e.Revenge="revenge",e.Fear="fear",e.Hatred="hatred",e.Protection="protection",e.Ambition="ambition",e))(k||{}),z=(e=>(e.Physical="physical",e.Testimonial="testimonial",e.Documentary="documentary",e.Behavioral="behavioral",e.Forensic="forensic",e))(z||{}),P=(e=>(e.Poison="poison",e.Knife="knife",e.Blunt="blunt",e.Firearm="firearm",e.Strangulation="strangulation",e.Pushed="pushed",e))(P||{});function dt(e){const t=e>12?e-12:e===0?12:e,n=e>=12?"PM":"AM";return{hour:e,label:`${t}:00 ${n}`}}function ut(e,t,n,s){return{honesty:e,composure:t,aggression:n,observance:s}}const pt=["Eleanor","Margaret","Victoria","Elizabeth","Catherine","Vivian","Evelyn","Beatrice","Charlotte","Penelope","Constance","Harriet","Agnes","Dorothy","Mildred","Irene","Lillian","Florence","Josephine","Rosalind","Agatha","Cordelia","Gwendolyn","Millicent","Prudence","Adelaide","Clementine","Ophelia","Tabitha","Winifred","Richard","William","Edward","Charles","Henry","James","Thomas","Arthur","Frederick","George","Sebastian","Oliver","Theodore","Reginald","Archibald","Edmund","Nathaniel","Humphrey","Percival","Bartholomew","Alistair","Benedict","Cornelius","Desmond","Montgomery","Rupert","Sylvester","Vincent","Wallace","Xavier"],ft=["Ashworth","Blackwood","Hartley","Pemberton","Whitmore","Ravencroft","Thornwood","Sterling","Fairfax","Cavendish","Montague","Sinclair","Worthington","Kensington","Beaumont","Crawford","Harrington","Lancaster","Fitzgerald","Stirling","Wellington","Carmichael","Prescott","Vandermeer","Ashford","Davenport","Everhart","Foxworth","Grenville","Hawthorne","Kingsley","Langley","Merriweather","Norwood","Osgood","Pembroke","Rutherford","Seymour","Trevelyan","Underwood","Vance","Wentworth","Yarborough","Aldridge","Bainbridge","Chadwick","Drummond","Eastwood","Farnsworth","Grimsby"],mt=[{title:"Industrialist",description:"A wealthy factory owner with vast holdings."},{title:"Socialite",description:"A prominent figure in high society."},{title:"Heiress",description:"A wealthy young woman expecting an inheritance."},{title:"Banker",description:"A financier who controls the family fortune."},{title:"Shipping Magnate",description:"Controls trade routes and harbors."},{title:"Oil Baron",description:"Made a fortune in petroleum."},{title:"Lawyer",description:"A shrewd legal mind who knows everyone's secrets."},{title:"Doctor",description:"A respected physician with a calm demeanor."},{title:"Professor",description:"An academic with an encyclopedic mind."},{title:"Architect",description:"Designs the grand estates of the wealthy."},{title:"Surgeon",description:"Steady hands and nerves of steel."},{title:"Barrister",description:"Argues cases before the highest courts."},{title:"Artist",description:"A temperamental creative with expensive tastes."},{title:"Actress",description:"A stage performer with a flair for drama."},{title:"Author",description:"A celebrated novelist known for dark themes."},{title:"Composer",description:"Creates symphonies that move audiences to tears."},{title:"Photographer",description:"Captures images that reveal hidden truths."},{title:"Colonel",description:"A retired military officer with rigid principles."},{title:"Politician",description:"An ambitious public figure with many enemies."},{title:"Diplomat",description:"A master of negotiation and intrigue."},{title:"Admiral",description:"Commanded fleets and sailors across the seas."},{title:"Judge",description:"Dispenses justice from the bench."},{title:"Butler",description:"A servant who sees and hears everything."},{title:"Journalist",description:"A reporter always digging for stories."},{title:"Private Secretary",description:"Manages affairs and keeps secrets."},{title:"Governess",description:"Raised the children of the wealthy."},{title:"Estate Manager",description:"Oversees the grounds and staff."},{title:"Widow",description:"Recently bereaved, with a complicated past."},{title:"Businessman",description:"A self-made entrepreneur with ruthless methods."},{title:"Antiquarian",description:"Deals in rare books and artifacts."},{title:"Explorer",description:"Has traveled to the far corners of the earth."},{title:"Spiritualist",description:"Claims to commune with the dead."}],ht=["A stern figure with penetrating eyes that miss nothing.","Charming on the surface, but calculating beneath.","Nervous and fidgety, clearly hiding something.","Watchful and silent, observing from the shadows.","Speaks in riddles and never gives a straight answer.","Always seems to know more than they let on.","Has a habit of appearing in unexpected places.","Quiet and reserved, with an air of hidden knowledge.","Imperious and cold, accustomed to getting their way.","Elegant and composed, never a hair out of place.","Meticulous and precise, obsessed with details.","Carries themselves with military bearing.","Speaks softly but commands attention.","Warm and friendly, perhaps too eager to please.","Theatrical and dramatic, always the center of attention.","Quick to anger, with a volatile temper.","Melancholic and brooding, lost in memories.","Laughs too loudly and drinks too much.","Disheveled and distracted, lost in thought.","Brash and outspoken, with no filter on their opinions.","Mutters to themselves when they think no one is listening.","Collects strange objects and speaks of stranger things.","Dresses decades out of fashion and cares not at all.","Has a noticeable limp from an old injury.","Constantly wringing their hands when speaking.","Never makes eye contact for more than a moment.","Chain-smokes and taps ashes nervously.","Wears dark glasses even indoors."];function gt(e,t){const n=new Set,s=[],i=t.shuffle(pt),a=t.shuffle(ft),c=t.shuffle(mt),o=t.shuffle(ht);for(let r=0;r<e.count;r++){const l=i[r%i.length],d=a[r%a.length],u=`${l} ${d}`;if(n.has(u)){const w=a[(r+1)%a.length],S=`${l} ${w}`;n.add(S)}else n.add(u);const p=c[r%c.length],f=o[r%o.length],h=vt(t),v=t.randomInt(25,70);s.push(fe({id:`suspect-${r}`,firstName:l,lastName:a[r%a.length],occupation:p.title,age:v,description:`${f} ${p.description}`,personality:h}))}return s}function vt(e){return ut(e.random(),e.random(),e.random(),e.random())}function yt(e,t){if(e.length<3)throw new Error("Need at least 3 suspects to assign victim and killer");const n=t.randomInt(0,e.length-1);let s=t.randomInt(0,e.length-1);for(;s===n;)s=t.randomInt(0,e.length-1);const i=fe({...e[n],id:e[n].id,isVictim:!0}),a=fe({...e[s],id:e[s].id,isKiller:!0}),c=e.filter((r,l)=>l!==n&&l!==s),o=t.shuffle(c);return{victim:i,killer:a,others:o}}function oe(e){const t=Math.max(-10,Math.min(10,e.sentiment));return Object.freeze({from:e.from,to:e.to,type:e.type,sentiment:t,isPublicKnowledge:e.isPublicKnowledge??!0,secretReason:e.secretReason})}function bt(e){return{[g.Spouse]:"married to",[g.ExSpouse]:"formerly married to",[g.Lover]:"romantically involved with",[g.ExLover]:"formerly involved with",[g.Sibling]:"sibling of",[g.Parent]:"parent of",[g.Child]:"child of",[g.Friend]:"friend of",[g.Rival]:"rival of",[g.Enemy]:"enemy of",[g.BusinessPartner]:"business partner of",[g.Employee]:"employed by",[g.Employer]:"employer of",[g.Acquaintance]:"acquaintance of"}[e.type]}const wt=[g.Spouse,g.ExSpouse,g.Lover,g.ExLover,g.Sibling,g.BusinessPartner,g.Rival,g.Enemy],St=Object.values(g);function $t(e,t,n,s,i,a={minConnectionsPerPerson:2}){const c=[],o=[e,t,...n],r=Et(t.id,e.id,s,i);c.push(r);const l=i.randomInt(2,Math.min(3,n.length)),d=i.shuffle(n);for(let f=0;f<l;f++){const h=d[f],v=i.pick(wt),w=i.randomInt(-8,-3);c.push(oe({from:h.id,to:e.id,type:v,sentiment:w,isPublicKnowledge:i.random()>.3}))}const u=new Map;o.forEach(f=>u.set(f.id,0));for(const f of c)u.set(f.from,(u.get(f.from)||0)+1),u.set(f.to,(u.get(f.to)||0)+1);for(const f of o){const h=u.get(f.id)||0;if(h<a.minConnectionsPerPerson){const v=a.minConnectionsPerPerson-h,w=o.filter(A=>A.id===f.id?!1:!c.some(y=>y.from===f.id&&y.to===A.id||y.from===A.id&&y.to===f.id)),S=i.shuffle(w);for(let A=0;A<Math.min(v,S.length);A++){const L=S[A],y=i.pick(St),$=i.randomInt(-5,8);c.push(oe({from:f.id,to:L.id,type:y,sentiment:$,isPublicKnowledge:i.random()>.2})),u.set(f.id,(u.get(f.id)||0)+1),u.set(L.id,(u.get(L.id)||0)+1)}}}const p=i.randomInt(1,2);for(let f=0;f<p;f++){const[h,v]=i.shuffle(o).slice(0,2);if(!c.some(S=>S.from===h.id&&S.to===v.id||S.from===v.id&&S.to===h.id)){const S=[g.Lover,g.ExLover,g.BusinessPartner],A=i.pick(S);c.push(oe({from:h.id,to:v.id,type:A,sentiment:i.randomInt(-3,7),isPublicKnowledge:!1,secretReason:At(A,i)}))}}return c}function Et(e,t,n,s){const i=kt(n,s),a=s.randomInt(-10,-6);return oe({from:e,to:t,type:i,sentiment:a,isPublicKnowledge:s.random()>.4})}function kt(e,t){const s={[k.Jealousy]:[g.Spouse,g.Lover,g.ExLover,g.Sibling],[k.Greed]:[g.Sibling,g.Child,g.Spouse,g.BusinessPartner],[k.Revenge]:[g.Enemy,g.ExSpouse,g.ExLover,g.Rival],[k.Fear]:[g.Employee,g.BusinessPartner,g.Acquaintance],[k.Hatred]:[g.Enemy,g.Rival,g.Sibling],[k.Protection]:[g.Parent,g.Spouse,g.Friend],[k.Ambition]:[g.Employee,g.BusinessPartner,g.Rival]}[e];return t.pick(s)}function At(e,t){const s={[g.Lover]:["An affair hidden from their spouses","A secret romance that would scandalize society","A forbidden relationship kept from the family"],[g.ExLover]:["A past affair no one knows about","A relationship that ended badly and was covered up"],[g.BusinessPartner]:["A secret business deal gone wrong","An undisclosed financial arrangement","A hidden investment that failed"]}[e]||["A secret connection hidden from others"];return t.pick(s)}function V(e){return Object.freeze({id:e.id,type:e.type,name:e.name,description:e.description,foundAt:e.foundAt,pointsTo:e.pointsTo,isRedHerring:e.isRedHerring??!1,refutedBy:e.refutedBy,significance:e.significance??"normal"})}function It(e,t,n,s,i,a,c,o,r,l={minCluesPointingToKiller:3,redHerringCount:2}){const d=[];let u=0;const p=()=>`clue-${u++}`;d.push(V({id:p(),type:z.Physical,name:Tt(i,r),description:xt(i,e,r),foundAt:a.id,pointsTo:e.id,significance:"critical"})),d.push(V({id:p(),type:z.Documentary,name:Ct(s,r),description:zt(s,t,e,r),foundAt:r.pick(c).id,pointsTo:e.id,significance:"critical"})),d.push(V({id:p(),type:z.Testimonial,name:"Witness Account",description:`Someone saw ${e.firstName} near the ${a.name} around the time of the murder.`,foundAt:a.id,pointsTo:e.id,significance:"normal"})),d.push(V({id:p(),type:z.Behavioral,name:"Suspicious Behavior",description:`${e.firstName} was seen acting nervously after the body was discovered.`,foundAt:r.pick(c).id,pointsTo:e.id,significance:"normal"})),d.push(V({id:p(),type:z.Forensic,name:"Time of Death",description:"The victim died between 9:00 PM and 10:00 PM based on body temperature.",foundAt:a.id,significance:"critical"}));for(const v of n)d.push(V({id:p(),type:z.Testimonial,name:`${v.firstName}'s Alibi`,description:`Multiple witnesses confirm ${v.firstName} was in the ${r.pick(c).name} during the time of the murder.`,foundAt:r.pick(c).id,pointsTo:v.id,significance:"normal"}));const f=r.shuffle(n);for(let v=0;v<Math.min(l.redHerringCount,f.length);v++){const w=f[v],S=d.find(A=>A.pointsTo===w.id&&A.type===z.Testimonial);d.push(V({id:p(),type:z.Physical,name:Nt(r),description:`Evidence that initially seems to implicate ${w.firstName}, but doesn't hold up to scrutiny.`,foundAt:a.id,pointsTo:w.id,isRedHerring:!0,refutedBy:S?.id,significance:"minor"}))}const h=o.find(v=>!v.isPublicKnowledge);if(h){const v=c.filter(S=>!S.isPublic),w=v.length>0?r.pick(v):r.pick(c);d.push(V({id:p(),type:z.Documentary,name:"Hidden Correspondence",description:`Letters revealing a secret ${h.type} relationship.`,foundAt:w.id,significance:"normal"}))}return r.shuffle(d)}function Tt(e,t){const n={[P.Poison]:["Poison Vial","Empty Medicine Bottle","Suspicious Powder"],[P.Knife]:["Bloodied Blade","Letter Opener","Kitchen Knife"],[P.Blunt]:["Dented Candlestick","Bronze Statue","Heavy Paperweight"],[P.Firearm]:["Discharged Revolver","Spent Shell Casing","Gun Oil Residue"],[P.Strangulation]:["Torn Silk Scarf","Rope Fibers","Ligature Marks"],[P.Pushed]:["Broken Railing","Torn Fabric on Balcony","Scuff Marks"]};return t.pick(n[e])}function xt(e,t,n){const s={[P.Poison]:[`An empty vial with traces of arsenic. The label has been torn off, but the style matches bottles in ${t.firstName}'s possession.`,"A small glass container that once held a deadly substance. Fingerprint analysis might prove useful."],[P.Knife]:["A blade stained with the victim's blood. The handle bears an unusual marking.","A sharp implement found near the body. It appears to have been wiped clean, but traces remain."],[P.Blunt]:["A heavy object bearing blood and hair. It was clearly used with considerable force.","The murder weapon, carelessly discarded. Forensic examination may reveal the killer's identity."],[P.Firearm]:["A revolver with one bullet missing from the chamber. Recently fired.","Shell casings found at the scene. The gun itself may still be in the house."],[P.Strangulation]:["Fabric fibers found under the victim's fingernails, torn during the struggle.","A distinctive pattern of bruising on the victim's neck suggests a specific type of ligature."],[P.Pushed]:["The railing shows signs of a struggle. Someone was pushed with great force.","Fabric caught on a nail near the balcony edge. The victim grabbed at something—or someone."]};return n.pick(s[e])}function Ct(e,t){const n={[k.Jealousy]:["Love Letters","Torn Photograph","Private Diary"],[k.Greed]:["Modified Will","Insurance Policy","Financial Records"],[k.Revenge]:["Threatening Letter","Legal Documents","Old Newspaper Clipping"],[k.Fear]:["Blackmail Note","Incriminating Photographs","Sealed Envelope"],[k.Hatred]:["Bitter Correspondence","Defaced Portrait","Burned Letters"],[k.Protection]:["Secret Documents","Hidden Evidence","Coded Messages"],[k.Ambition]:["Business Contract","Promotion Letter","Partnership Agreement"]};return t.pick(n[e])}function zt(e,t,n,s){const i={[k.Jealousy]:[`Documents revealing ${n.firstName}'s jealousy over ${t.firstName}'s romantic entanglements.`,`Evidence of a love triangle that drove ${n.firstName} to desperate measures.`],[k.Greed]:[`Papers showing ${n.firstName} stood to inherit a fortune upon ${t.firstName}'s death.`,`Financial documents revealing ${n.firstName} was about to be cut out of the will.`],[k.Revenge]:[`Letters documenting a past wrong that ${n.firstName} could never forgive.`,"Evidence of an old betrayal that festered into murderous rage."],[k.Fear]:[`${t.firstName} had discovered something about ${n.firstName} that could destroy them.`,`Blackmail materials showing ${n.firstName} was being threatened with exposure.`],[k.Hatred]:[`A long history of animosity between ${n.firstName} and the victim, documented in bitter letters.`,"Evidence of a deep-seated hatred that finally boiled over."],[k.Protection]:[`Documents showing ${n.firstName} killed to protect someone else—or a terrible secret.`,`${t.firstName} was about to expose something that would harm someone ${n.firstName} loves.`],[k.Ambition]:[`${t.firstName} was standing in the way of ${n.firstName}'s advancement.`,`Business documents showing ${n.firstName} would gain power or position from the death.`]};return s.pick(i[e])}function Nt(e){const t=["Suspicious Object","Misplaced Item","Circumstantial Evidence","Misleading Clue","Planted Evidence"];return e.pick(t)}function j(e){return Object.freeze({suspectId:e.suspectId,timeSlot:e.timeSlot,location:e.location,description:e.description,witnesses:Object.freeze(e.witnesses??[]),isVerifiable:e.isVerifiable??!0,isFalse:e.isFalse??!1})}function Pt(e,t,n,s,i,a){const c=[],o=s.filter(p=>p.isPublic),r=s.filter(p=>!p.isPublic),l=[e,...n],d=a.pick(["no_witnesses","unreliable_witness","partial_alibi","conflicting_times"]);for(const p of n){const f=a.pick(o),h=Pe(p.id,l,a);if(a.random()<.2){const w=h.slice(0,1);c.push(j({suspectId:p.id,timeSlot:i,location:f.id,description:Bt(p,f,w,a),witnesses:w.map(S=>S.id),isVerifiable:!0,isFalse:!1}))}else c.push(j({suspectId:p.id,timeSlot:i,location:f.id,description:Lt(p,f,h,a),witnesses:h.map(w=>w.id),isVerifiable:!0,isFalse:!1}))}const u=Mt(e,n,o,r,i,d,a);return c.push(u),a.shuffle(c)}function Mt(e,t,n,s,i,a,c){switch(a){case"unreliable_witness":{const o=c.pick(n.length>0?n:s),r=c.pick(t);return j({suspectId:e.id,timeSlot:i,location:o.id,description:Ot(e,o,r,c),witnesses:[r.id],isVerifiable:!1,isFalse:!0})}case"partial_alibi":{const o=c.pick(n.length>0?n:s),r=Pe(e.id,[e,...t],c);return j({suspectId:e.id,timeSlot:i,location:o.id,description:qt(e,o,r,c),witnesses:r.map(l=>l.id),isVerifiable:!1,isFalse:!0})}case"conflicting_times":{const o=c.pick(s.length>0?s:n);return j({suspectId:e.id,timeSlot:i,location:o.id,description:Dt(e,o,c),witnesses:[],isVerifiable:!1,isFalse:!0})}case"no_witnesses":default:{const o=s.length>0?c.pick(s):c.pick(n);return j({suspectId:e.id,timeSlot:i,location:o.id,description:Rt(e,o,c),witnesses:[],isVerifiable:!1,isFalse:!0})}}}function Pe(e,t,n){const s=t.filter(a=>a.id!==e&&!a.isVictim),i=n.randomInt(1,Math.min(2,s.length));return n.shuffle(s).slice(0,i)}function Lt(e,t,n,s){const i=["was having a conversation","was reading by the fire","was playing cards","was admiring the paintings","was engaged in discussion","was enjoying a drink","was waiting for dinner"],a=s.pick(i);if(n.length===0)return`${e.firstName} claims to have been in the ${t.name}, ${a}.`;const c=n.map(o=>o.firstName).join(" and ");return`${e.firstName} was in the ${t.name}, ${a}. ${c} can confirm this.`}function Rt(e,t,n){const s=[`${e.firstName} claims to have been alone in ${t.name==="Guest Bedroom"?"their room":`the ${t.name}`}, resting.`,`${e.firstName} says they were in the ${t.name}, but no one can confirm this.`,`${e.firstName} insists they were freshening up in their quarters.`,`${e.firstName} claims to have stepped outside for some air.`,`${e.firstName} says they were in the ${t.name} making a private telephone call.`];return n.pick(s)}function Bt(e,t,n,s){const i=[`${e.firstName} was seen briefly in the ${t.name}, though the exact time is unclear.`,`${e.firstName} claims to have been in the ${t.name}. ${n[0]?.firstName||"Someone"} thinks they may have seen them there.`,`${e.firstName} says they were in the ${t.name}, reading. ${n[0]?.firstName||"A witness"} recalls seeing them, but can't be certain of the time.`,`${e.firstName} was in the ${t.name} for part of the evening, according to ${n[0]?.firstName||"a witness"}, who was somewhat distracted.`];return s.pick(i)}function Ot(e,t,n,s){const i=[`${e.firstName} claims ${n.firstName} saw them in the ${t.name}. However, ${n.firstName} had been drinking heavily that evening.`,`${e.firstName} says they were with ${n.firstName} in the ${t.name}, but ${n.firstName}'s memory of the evening is hazy.`,`${e.firstName} insists ${n.firstName} can vouch for them, though ${n.firstName} seems oddly reluctant to confirm the details.`,`${e.firstName} claims ${n.firstName} saw them in the ${t.name}. ${n.firstName} agrees, but their account has some inconsistencies.`];return s.pick(i)}function qt(e,t,n,s){const i=n[0]?.firstName||"Others",a=[`${e.firstName} was seen in the ${t.name} earlier in the evening by ${i}, but stepped out for a while around the time of the murder.`,`${i} saw ${e.firstName} in the ${t.name} before dinner, but not during the critical hour.`,`${e.firstName} arrived at the ${t.name} late, claiming to have been delayed. ${i} can only confirm their presence after the fact.`,`${e.firstName} was in the ${t.name} with ${i}, but excused themselves for about twenty minutes during the evening.`];return s.pick(a)}function Dt(e,t,n){const s=[`${e.firstName} claims to have been in the ${t.name} from 8 until 10, but the grandfather clock there stopped at 9:15.`,`${e.firstName} says they were in the ${t.name} all evening, but a servant recalls seeing the room empty around 9 o'clock.`,`${e.firstName} insists they never left the ${t.name}, yet their shoes show traces of garden mud.`,`${e.firstName} claims they were reading in the ${t.name}, but the book they mention wasn't published until next year.`,`${e.firstName} says they heard the clock strike nine from the ${t.name}, but that clock has been broken for weeks.`];return n.pick(s)}function Gt(e){return Object.freeze({seed:e.seed,suspects:Object.freeze([...e.suspects]),relationships:Object.freeze([...e.relationships]),locations:Object.freeze([...e.locations]),clues:Object.freeze([...e.clues]),alibis:Object.freeze([...e.alibis]),victim:e.victim,killer:e.killer,motive:e.motive,weapon:e.weapon,crimeScene:e.crimeScene,timeOfDeath:e.timeOfDeath})}function _t(e){return e.suspects.find(t=>t.id===e.victim)}function ve(e){return e.suspects.filter(t=>!t.isVictim)}function Kt(e,t){return e.clues.filter(n=>n.pointsTo===t)}function Vt(e){return Kt(e,e.killer).length>0}function Me(e){return Object.freeze({id:e.id,name:e.name,description:e.description,isPublic:e.isPublic??!0,isCrimeScene:e.isCrimeScene??!1})}const Ft=[{name:"Study",description:"A wood-paneled room lined with leather-bound books. The smell of tobacco lingers in the air.",isPublic:!1},{name:"Master Bedroom",description:"An opulent bedroom with a four-poster bed and heavy curtains.",isPublic:!1},{name:"Guest Bedroom",description:"A comfortable but less ornate sleeping quarters for visitors.",isPublic:!1},{name:"Kitchen",description:"A large kitchen with copper pots hanging from the ceiling and the scent of herbs.",isPublic:!1},{name:"Wine Cellar",description:"A cool underground room with racks of vintage bottles and cobwebs in the corners.",isPublic:!1},{name:"Servant's Quarters",description:"Simple rooms behind the kitchen where the staff resides.",isPublic:!1},{name:"Attic",description:"A dusty space beneath the rafters, filled with forgotten trunks and memories.",isPublic:!1},{name:"Parlor",description:"An elegant sitting room with velvet furniture and a crackling fireplace.",isPublic:!0},{name:"Dining Room",description:"A grand dining room with a long mahogany table set with fine china.",isPublic:!0},{name:"Library",description:"Floor-to-ceiling bookshelves surround comfortable reading chairs. A ladder slides along the shelves.",isPublic:!0},{name:"Conservatory",description:"A glass-walled room filled with exotic plants and humid air. Moonlight streams through the panes.",isPublic:!0},{name:"Billiard Room",description:"A masculine retreat with a green-felted table and trophy heads on the walls.",isPublic:!0},{name:"Garden",description:"A manicured garden with hedges, fountains, and hidden alcoves. Rose bushes line the paths.",isPublic:!0},{name:"Foyer",description:"The grand entrance hall with a sweeping staircase and crystal chandelier.",isPublic:!0},{name:"Music Room",description:"A room dominated by a grand piano and walls hung with portraits of composers.",isPublic:!0},{name:"Drawing Room",description:"A formal reception room with silk wallpaper and delicate porcelain figurines.",isPublic:!0},{name:"Ballroom",description:"A vast room with polished floors and mirrors that multiply the candlelight.",isPublic:!0},{name:"Veranda",description:"A covered porch overlooking the grounds. Wicker chairs face the gardens.",isPublic:!0},{name:"Trophy Room",description:"Mounted heads and hunting memorabilia cover every surface. A rifle case stands in the corner.",isPublic:!0}],jt={suspectCount:6,difficulty:"medium"};function Le(e,t={}){const n={...jt,...t},s=Ne(e),i=Ht(s),a=gt({count:n.suspectCount},s),{victim:c,killer:o,others:r}=yt(a,s),l=Ut(s),d=Xt(s),u=Wt(i,s),p=Yt(s),f=$t(c,o,r,l,s),h=It(o,c,r,l,d,u,i,f,s,{redHerringCount:Jt(n.difficulty)}),v=Pt(o,c,r,i,p,s),w=Gt({seed:e,suspects:[c,o,...r],relationships:f,locations:i,clues:h,alibis:v,victim:c.id,killer:o.id,motive:l,weapon:d,crimeScene:u.id,timeOfDeath:p});return Vt(w)?w:(console.warn("Generated case is not solvable, regenerating..."),Le(`${e}-retry`,t))}function Ht(e){const t=e.shuffle(Ft),n=e.randomInt(6,8);return t.slice(0,n).map((s,i)=>Me({id:`location-${i}`,name:s.name,description:s.description,isPublic:s.isPublic,isCrimeScene:!1}))}function Wt(e,t){const n=e.filter(a=>!a.isPublic),s=n.length>0?n:e,i=t.pick(s);return Me({id:i.id,name:i.name,description:i.description,isPublic:i.isPublic,isCrimeScene:!0})}function Ut(e){const t=Object.values(k);return e.pick(t)}function Xt(e){const t=Object.values(P);return e.pick(t)}function Yt(e){const t=e.randomInt(20,23);return dt(t)}function Jt(e){switch(e){case"easy":return 1;case"medium":return 2;case"hard":return 3}}function Qt(){return{discoveredClues:new Set,examinedLocations:new Set,interrogatedSuspects:new Set,revealedContradictions:new Set,notes:new Map}}function Zt(e){return{phase:"intro",generatedCase:e,playerKnowledge:Qt(),currentLocation:e.crimeScene,interrogation:null,accusation:null,result:null,mistakeCount:0,maxMistakes:5,searchTokens:3}}function en(e,t){const n=new Map,s=e.suspects.filter(i=>!i.isVictim);for(const i of s){const a=e.alibis.find(l=>l.suspectId===i.id),c=e.relationships.filter(l=>l.from===i.id||l.to===i.id),o=e.suspects.find(l=>l.isVictim),r=tn(i,o,a,c,e,t);n.set(i.id,{suspectId:i.id,statements:r})}return n}function tn(e,t,n,s,i,a){const c=[];let o=0;const r=()=>`${e.id}-stmt-${o++}`;if(n){const d=nn(r(),e,n,i);c.push(d)}const l=s.find(d=>d.to===t.id||d.from===t.id);return l&&c.push(sn(r(),e,t,l,i)),c.push(rn(r(),e,i,a)),c.push(on(r(),e,t,i,a)),c}function nn(e,t,n,s){const a=s.locations.find(o=>o.id===n.location)?.name||"somewhere",c=s.clues.filter(o=>o.pointsTo===t.id&&!o.isRedHerring?o.type===z.Testimonial||o.type===z.Physical:!1).map(o=>o.id);if(n.isFalse)return{id:e,suspectId:t.id,text:`I was in the ${a} the entire evening. I never left.`,topic:"alibi",isLie:!0,contradictedBy:c,pressResponse:"I'm quite certain. I was... resting. Alone, yes, but I was definitely there.",truthReveal:`...Fine. I wasn't in the ${a} the whole time. But that doesn't mean I did anything wrong!`};{const o=n.witnesses.map(r=>s.suspects.find(l=>l.id===r)?.firstName).filter(Boolean).join(" and ");return{id:e,suspectId:t.id,text:`I was in the ${a} during that time. ${o?`${o} can confirm this.`:"I was alone, but I assure you I was there."}`,topic:"alibi",isLie:!1,contradictedBy:[],pressResponse:o?`Ask ${o} if you don't believe me. They'll tell you I was there.`:"I know I can't prove it, but I swear I was there. I had no reason to leave."}}}function sn(e,t,n,s,i){const a=bt(s),c=!s.isPublicKnowledge,o=s.sentiment<-3,r=i.clues.filter(l=>l.type===z.Documentary&&l.description.toLowerCase().includes("relationship")).map(l=>l.id);return c?{id:e,suspectId:t.id,text:`${n.firstName}? We were merely acquaintances. Nothing more.`,topic:"relationships",isLie:!0,contradictedBy:r,pressResponse:"I don't know what you're implying. We barely knew each other.",truthReveal:`...Alright. ${n.firstName} and I were... closer than I let on. But that's private!`}:o?{id:e,suspectId:t.id,text:`${n.firstName} and I... didn't always see eye to eye. But I didn't kill them!`,topic:"relationships",isLie:!1,contradictedBy:[],pressResponse:`Yes, we had our disagreements. ${n.firstName} could be difficult. But murder? Never.`}:{id:e,suspectId:t.id,text:`I was ${a} ${n.firstName}. We got along well enough.`,topic:"relationships",isLie:!1,contradictedBy:[],pressResponse:"There's not much more to say. We had a normal relationship."}}function rn(e,t,n,s){const i=t.isKiller,a=n.locations.find(o=>o.id===n.crimeScene),c=i?n.clues.filter(o=>o.type===z.Testimonial&&o.pointsTo===t.id).map(o=>o.id):[];if(i){const o=[{text:"I didn't see anything unusual that evening. Everything seemed perfectly normal.",pressResponse:"I was... preoccupied. I wasn't paying attention to others."},{text:"I kept to myself most of the evening. I'm afraid I can't help you.",pressResponse:"I don't make it a habit to spy on others. I minded my own business."},{text:"The evening was unremarkable until we heard the scream. I was as shocked as everyone.",pressResponse:"What more do you want me to say? I didn't see who did it."},{text:"I was distracted all evening. Personal matters, you understand. I noticed nothing.",pressResponse:"My thoughts were elsewhere. The evening is a blur, honestly."},{text:"Everyone seemed normal to me. I had no reason to suspect anything was wrong.",pressResponse:"In hindsight, perhaps I should have paid more attention. But I didn't."}],r=s.pick(o);return{id:e,suspectId:t.id,text:r.text,topic:"observations",isLie:!0,contradictedBy:c,pressResponse:r.pressResponse,truthReveal:`Stop pressuring me! I... I may have been near the ${a?.name||"scene"}. But I didn't do anything!`}}else{const o=["I thought I heard raised voices at one point, but I couldn't make out the words.",`I noticed ${D(n.suspects.find(r=>r.isKiller))} seemed distracted that evening.`,"The atmosphere felt tense, but I attributed it to the usual family drama.","I saw someone moving through the hallway, but it was too dark to tell who."];return{id:e,suspectId:t.id,text:s.pick(o),topic:"observations",isLie:!1,contradictedBy:[],pressResponse:"That's all I know. I wish I had paid more attention."}}}function on(e,t,n,s,i){const a=t.isKiller,c=s.clues.filter(o=>o.type===z.Documentary&&o.pointsTo===t.id&&o.significance==="critical").map(o=>o.id);if(a)return{id:e,suspectId:t.id,text:`I had no reason to want ${n.firstName} dead. None at all.`,topic:"self",isLie:!0,contradictedBy:c,pressResponse:"Why would I? I had nothing to gain from this tragedy.",truthReveal:"...You found out about that? Fine. Yes, I had... reasons. But that doesn't prove I killed anyone!"};{const o=["I know how this looks, but I'm innocent. Please believe me.",`I may not have liked ${n.firstName}, but I'm not a murderer.`,"You're wasting time suspecting me. The real killer is still out there.","I have nothing to hide. Ask me anything."];return{id:e,suspectId:t.id,text:i.pick(o),topic:"self",isLie:!1,contradictedBy:[],pressResponse:"I understand you have to investigate everyone. I just hope you find the truth."}}}function an(e,t){return e.contradictedBy.includes(t)}function cn(e,t){switch(t.type){case"START_GAME":return{...e,phase:"investigation"};case"EXAMINE_LOCATION":return{...e,currentLocation:t.locationId,playerKnowledge:{...e.playerKnowledge,examinedLocations:new Set([...e.playerKnowledge.examinedLocations,t.locationId])}};case"DISCOVER_CLUE":return{...e,playerKnowledge:{...e.playerKnowledge,discoveredClues:new Set([...e.playerKnowledge.discoveredClues,t.clueId])}};case"START_INTERROGATION":return{...e,interrogation:{suspectId:t.suspectId,currentStatementIndex:0,pressedStatements:new Set,presentedEvidence:new Map},playerKnowledge:{...e.playerKnowledge,interrogatedSuspects:new Set([...e.playerKnowledge.interrogatedSuspects,t.suspectId])}};case"END_INTERROGATION":return{...e,interrogation:null};case"NEXT_STATEMENT":return e.interrogation?{...e,interrogation:{...e.interrogation,currentStatementIndex:e.interrogation.currentStatementIndex+1}}:e;case"PREVIOUS_STATEMENT":return e.interrogation?{...e,interrogation:{...e.interrogation,currentStatementIndex:Math.max(0,e.interrogation.currentStatementIndex-1)}}:e;case"PRESS_STATEMENT":return e.interrogation?{...e,interrogation:{...e.interrogation,pressedStatements:new Set([...e.interrogation.pressedStatements,e.interrogation.currentStatementIndex])}}:e;case"PRESENT_EVIDENCE":return e.interrogation?an(t.statement,t.clueId)?{...e,interrogation:{...e.interrogation,presentedEvidence:new Map([...e.interrogation.presentedEvidence,[e.interrogation.currentStatementIndex,t.clueId]])},playerKnowledge:{...e.playerKnowledge,revealedContradictions:new Set([...e.playerKnowledge.revealedContradictions,t.statement.id])}}:{...e,mistakeCount:e.mistakeCount+1}:e;case"ADD_NOTE":return{...e,playerKnowledge:{...e.playerKnowledge,notes:new Map([...e.playerKnowledge.notes,[t.suspectId,t.note]])}};case"START_ACCUSATION":return{...e,phase:"accusation"};case"SET_ACCUSATION":return{...e,accusation:t.accusation};case"CONFIRM_ACCUSATION":{if(!e.accusation)return e;const n=e.generatedCase.killer,s=e.accusation.accusedId===n,i=ln(t.testimonies),a={won:s,correctKiller:n,playerAccused:e.accusation.accusedId,cluesFound:e.playerKnowledge.discoveredClues.size,totalClues:e.generatedCase.clues.length,contradictionsFound:e.playerKnowledge.revealedContradictions.size,totalContradictions:i};return{...e,phase:"resolution",result:a}}case"CANCEL_ACCUSATION":return{...e,phase:"investigation",accusation:null};case"ADD_SEARCH_TOKENS":return{...e,searchTokens:e.searchTokens+t.amount};case"SPEND_SEARCH_TOKEN":return{...e,searchTokens:Math.max(0,e.searchTokens-1)};default:return e}}function ln(e){let t=0;for(const n of e.values())for(const s of n.statements)s.isLie&&s.contradictedBy.length>0&&t++;return t}const I={startGame:()=>({type:"START_GAME"}),examineLocation:e=>({type:"EXAMINE_LOCATION",locationId:e}),discoverClue:e=>({type:"DISCOVER_CLUE",clueId:e}),startInterrogation:e=>({type:"START_INTERROGATION",suspectId:e}),endInterrogation:()=>({type:"END_INTERROGATION"}),nextStatement:()=>({type:"NEXT_STATEMENT"}),previousStatement:()=>({type:"PREVIOUS_STATEMENT"}),pressStatement:()=>({type:"PRESS_STATEMENT"}),presentEvidence:(e,t)=>({type:"PRESENT_EVIDENCE",clueId:e,statement:t}),addNote:(e,t)=>({type:"ADD_NOTE",suspectId:e,note:t}),startAccusation:()=>({type:"START_ACCUSATION"}),setAccusation:e=>({type:"SET_ACCUSATION",accusation:e}),confirmAccusation:e=>({type:"CONFIRM_ACCUSATION",testimonies:e}),cancelAccusation:()=>({type:"CANCEL_ACCUSATION"}),addSearchTokens:e=>({type:"ADD_SEARCH_TOKENS",amount:e}),spendSearchToken:()=>({type:"SPEND_SEARCH_TOKEN"})};function xe(e){let t=e;const n=new Set;return{getState:()=>t,dispatch:s=>{t=cn(t,s),n.forEach(i=>i(t))},subscribe:s=>(n.add(s),()=>n.delete(s))}}class dn{state={musicEnabled:!0,sfxEnabled:!0,musicVolume:.3,sfxVolume:.5,currentTrack:null};audioContext=null;musicGain=null;currentMusic=null;currentMusicGain=null;getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.state.musicVolume),this.audioContext}playSfx(t){if(!this.state.sfxEnabled)return;const n=this.getAudioContext();n.state==="suspended"&&n.resume();const s=n.createGain();switch(s.connect(n.destination),s.gain.value=this.state.sfxVolume,t){case"objection":this.playObjectionSound(n,s);break;case"holdit":this.playHoldItSound(n,s);break;case"contradiction":this.playContradictionSound(n,s);break;case"wrong":this.playWrongSound(n,s);break;case"clue_found":this.playClueFoundSound(n,s);break;case"typewriter":this.playTypewriterSound(n,s);break;case"page_turn":this.playPageTurnSound(n,s);break;case"dramatic_hit":this.playDramaticHitSound(n,s);break}}playObjectionSound(t,n){const s=t.createOscillator(),i=t.createOscillator();s.type="sawtooth",i.type="square",s.frequency.setValueAtTime(220,t.currentTime),i.frequency.setValueAtTime(330,t.currentTime),n.gain.setValueAtTime(.6,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),s.connect(n),i.connect(n),s.start(t.currentTime),i.start(t.currentTime),s.stop(t.currentTime+.5),i.stop(t.currentTime+.5)}playHoldItSound(t,n){const s=t.createOscillator();s.type="triangle",s.frequency.setValueAtTime(440,t.currentTime),s.frequency.exponentialRampToValueAtTime(880,t.currentTime+.1),n.gain.setValueAtTime(.4,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),s.connect(n),s.start(t.currentTime),s.stop(t.currentTime+.3)}playContradictionSound(t,n){[261.63,329.63,392,523.25].forEach((i,a)=>{const c=t.createOscillator();c.type="sine",c.frequency.setValueAtTime(i,t.currentTime);const o=t.createGain();o.connect(n),o.gain.setValueAtTime(0,t.currentTime+a*.05),o.gain.linearRampToValueAtTime(.3,t.currentTime+a*.05+.05),o.gain.exponentialRampToValueAtTime(.01,t.currentTime+.8),c.connect(o),c.start(t.currentTime+a*.05),c.stop(t.currentTime+.8)})}playWrongSound(t,n){const s=t.createOscillator();s.type="sawtooth",s.frequency.setValueAtTime(150,t.currentTime),s.frequency.exponentialRampToValueAtTime(80,t.currentTime+.3),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),s.connect(n),s.start(t.currentTime),s.stop(t.currentTime+.3)}playClueFoundSound(t,n){[523.25,659.25,783.99].forEach((i,a)=>{const c=t.createOscillator();c.type="sine",c.frequency.setValueAtTime(i,t.currentTime);const o=t.createGain();o.connect(n),o.gain.setValueAtTime(0,t.currentTime+a*.1),o.gain.linearRampToValueAtTime(.25,t.currentTime+a*.1+.05),o.gain.exponentialRampToValueAtTime(.01,t.currentTime+.6),c.connect(o),c.start(t.currentTime+a*.1),c.stop(t.currentTime+.6)})}playTypewriterSound(t,n){const s=t.sampleRate*.02,i=t.createBuffer(1,s,t.sampleRate),a=i.getChannelData(0);for(let o=0;o<s;o++)a[o]=(Math.random()*2-1)*Math.exp(-o/(s*.1));const c=t.createBufferSource();c.buffer=i,n.gain.setValueAtTime(.15,t.currentTime),c.connect(n),c.start(t.currentTime)}playPageTurnSound(t,n){const s=t.sampleRate*.15,i=t.createBuffer(1,s,t.sampleRate),a=i.getChannelData(0);for(let r=0;r<s;r++){const l=Math.sin(r/s*Math.PI);a[r]=(Math.random()*2-1)*l*.3}const c=t.createBufferSource();c.buffer=i;const o=t.createBiquadFilter();o.type="bandpass",o.frequency.setValueAtTime(2e3,t.currentTime),o.Q.value=1,c.connect(o),o.connect(n),n.gain.setValueAtTime(.2,t.currentTime),c.start(t.currentTime)}playDramaticHitSound(t,n){const s=t.createOscillator();s.type="sine",s.frequency.setValueAtTime(80,t.currentTime),s.frequency.exponentialRampToValueAtTime(30,t.currentTime+.5);const i=t.createWaveShaper(),a=new Float32Array(256);for(let c=0;c<256;c++){const o=c/128-1;a[c]=Math.tanh(o*2)}i.curve=a,n.gain.setValueAtTime(.5,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),s.connect(i),i.connect(n),s.start(t.currentTime),s.stop(t.currentTime+.5)}playMusic(t){if(!this.state.musicEnabled||this.state.currentTrack===t)return;this.stopMusic(),this.state.currentTrack=t;const n=this.getAudioContext();n.state==="suspended"&&n.resume();const s=n.createOscillator(),i=n.createOscillator(),a=n.createOscillator();this.currentMusicGain=n.createGain(),this.currentMusicGain.connect(this.musicGain);const c=n.createGain();switch(c.gain.value=10,a.type="sine",a.frequency.value=.1,a.connect(c),s.type="sine",i.type="triangle",t){case"investigation":s.frequency.value=110,i.frequency.value=165,this.currentMusicGain.gain.value=.08;break;case"interrogation":s.frequency.value=82.41,i.frequency.value=123.47,this.currentMusicGain.gain.value=.1;break;case"tension":s.frequency.value=73.42,i.frequency.value=77.78,this.currentMusicGain.gain.value=.12;break;case"victory":s.frequency.value=130.81,i.frequency.value=196,this.currentMusicGain.gain.value=.1;break;case"defeat":s.frequency.value=55,i.frequency.value=65.41,this.currentMusicGain.gain.value=.1;break}c.connect(s.frequency),s.connect(this.currentMusicGain),i.connect(this.currentMusicGain),a.start(),s.start(),i.start(),this.currentMusic=s}stopMusic(){if(this.currentMusic){try{this.currentMusic.stop()}catch{}this.currentMusic=null}this.state.currentTrack=null}toggleMusic(){return this.state.musicEnabled=!this.state.musicEnabled,this.state.musicEnabled||this.stopMusic(),this.state.musicEnabled}toggleSfx(){return this.state.sfxEnabled=!this.state.sfxEnabled,this.state.sfxEnabled}setMusicVolume(t){this.state.musicVolume=Math.max(0,Math.min(1,t)),this.musicGain&&(this.musicGain.gain.value=this.state.musicVolume)}setSfxVolume(t){this.state.sfxVolume=Math.max(0,Math.min(1,t))}isMusicEnabled(){return this.state.musicEnabled}isSfxEnabled(){return this.state.sfxEnabled}}const N=new dn,le="black_rabbit_save";function un(e,t){const n={phase:e.phase,generatedCase:e.generatedCase,playerKnowledge:{discoveredClues:Array.from(e.playerKnowledge.discoveredClues),examinedLocations:Array.from(e.playerKnowledge.examinedLocations),interrogatedSuspects:Array.from(e.playerKnowledge.interrogatedSuspects),revealedContradictions:Array.from(e.playerKnowledge.revealedContradictions),notes:Array.from(e.playerKnowledge.notes.entries())},currentLocation:e.currentLocation,interrogation:e.interrogation?{suspectId:e.interrogation.suspectId,currentStatementIndex:e.interrogation.currentStatementIndex,pressedStatements:Array.from(e.interrogation.pressedStatements),presentedEvidence:Array.from(e.interrogation.presentedEvidence.entries())}:null,accusation:e.accusation,result:e.result,mistakeCount:e.mistakeCount,maxMistakes:e.maxMistakes,searchTokens:e.searchTokens,seed:t};try{localStorage.setItem(le,JSON.stringify(n))}catch(s){console.warn("Failed to save game:",s)}}function pn(){try{const e=localStorage.getItem(le);if(!e)return null;const t=JSON.parse(e),n={discoveredClues:new Set(t.playerKnowledge.discoveredClues),examinedLocations:new Set(t.playerKnowledge.examinedLocations),interrogatedSuspects:new Set(t.playerKnowledge.interrogatedSuspects),revealedContradictions:new Set(t.playerKnowledge.revealedContradictions),notes:new Map(t.playerKnowledge.notes.map(([a,c])=>[a,c]))},s=t.interrogation?{suspectId:t.interrogation.suspectId,currentStatementIndex:t.interrogation.currentStatementIndex,pressedStatements:new Set(t.interrogation.pressedStatements),presentedEvidence:new Map(t.interrogation.presentedEvidence.map(([a,c])=>[a,c]))}:null;return{state:{phase:t.phase,generatedCase:t.generatedCase,playerKnowledge:n,currentLocation:t.currentLocation,interrogation:s,accusation:t.accusation,result:t.result,mistakeCount:t.mistakeCount,maxMistakes:t.maxMistakes,searchTokens:t.searchTokens??3},seed:t.seed}}catch(e){return console.warn("Failed to load game:",e),null}}function ae(){try{localStorage.removeItem(le)}catch(e){console.warn("Failed to clear save:",e)}}function fn(){try{return localStorage.getItem(le)!==null}catch{return!1}}const M=12,G=6,Ce=["magnifier","fingerprint","document","witness","key","badge"],mn={magnifier:"🔍",fingerprint:"👆",document:"📄",witness:"👁",key:"🗝",badge:"🛡"},hn={line_h:"↔",line_v:"↕",cross:"✚",blast:"💥"};let gn=0;function ye(){return`panel-${gn++}`}function be(){return Ce[Math.floor(Math.random()*Ce.length)]}function vn(e=500,t=60){const n=[];for(let s=0;s<M;s++){n[s]=[];for(let i=0;i<G;i++)n[s][i]=null}for(let s=6;s<M;s++)for(let i=0;i<G;i++)n[s][i]={type:be(),bonus:null,row:s,col:i,id:ye()};return yn(n),{grid:n,score:0,combo:0,targetScore:e,timeRemaining:t,isAnimating:!1,isGameOver:!1,riseProgress:0,nextRow:Re(),selected:null}}function yn(e){let t=!0,n=0;const s=100;for(;t&&n<s;){const i=de(e);if(i.length===0)t=!1;else for(const a of i)for(const c of a.positions)e[c.row][c.col]&&(e[c.row][c.col].type=be());n++}}function Re(){return Array.from({length:G},(e,t)=>({type:be(),bonus:null,row:M,col:t,id:ye()}))}function ze(e,t,n){return e.isAnimating||e.isGameOver?{...e,selected:null}:e.grid[t]?.[n]?e.selected?.row===t&&e.selected?.col===n?{...e,selected:null}:{...e,selected:{row:t,col:n}}:e}function bn(e,t,n,s){const i=Math.abs(e-n),a=Math.abs(t-s);return i===1&&a===0||i===0&&a===1}function wn(e,t,n){if(!e.selected)return{swapped:!1,state:e};const{row:s,col:i}=e.selected;if(!bn(s,i,t,n))return{swapped:!1,state:e};const a=e.grid.map(l=>[...l]),c=a[s][i],o=a[t][n];return a[s][i]=o,a[t][n]=c,a[s][i]&&(a[s][i]={...a[s][i],row:s,col:i}),a[t][n]&&(a[t][n]={...a[t][n],row:t,col:n}),de(a).length===0?{swapped:!1,state:{...e,selected:null}}:{swapped:!0,state:{...e,grid:a,selected:null,isAnimating:!0}}}function de(e){const t=[],n=[];for(let o=0;o<M;o++){let r=[];for(let l=0;l<G;l++){const d=e[o][l];d&&(r.length===0||d.type===r[0].type)?r.push({row:o,col:l,type:d.type}):(r.length>=3&&n.push([...r]),r=d?[{row:o,col:l,type:d.type}]:[])}r.length>=3&&n.push([...r])}const s=[];for(let o=0;o<G;o++){let r=[];for(let l=0;l<M;l++){const d=e[l][o];d&&(r.length===0||d.type===r[0].type)?r.push({row:l,col:o,type:d.type}):(r.length>=3&&s.push([...r]),r=d?[{row:l,col:o,type:d.type}]:[])}r.length>=3&&s.push([...r])}const i=new Map;for(const o of n)for(const r of o){const l=`${r.row},${r.col}`,d=i.get(l)||{};d.h=o,i.set(l,d)}for(const o of s)for(const r of o){const l=`${r.row},${r.col}`,d=i.get(l)||{};d.v=o,i.set(l,d)}const a=new Set,c=new Set;for(const[o,r]of i)if(r.h&&r.v&&!a.has(r.h)&&!c.has(r.v)){const l=new Set;for(const y of r.h)l.add(`${y.row},${y.col}`);for(const y of r.v)l.add(`${y.row},${y.col}`);const d=Array.from(l).map(y=>{const[$,C]=y.split(",").map(Number);return{row:$,col:C}}),[u,p]=o.split(",").map(Number),f=r.h[0].col,h=r.h[r.h.length-1].col,v=r.v[0].row,w=r.v[r.v.length-1].row,S=p>f&&p<h,A=u>v&&u<w,L=S||A?"T":"L";t.push({positions:d,direction:"both",shape:L,type:r.h[0].type}),a.add(r.h),c.add(r.v)}for(const o of n)a.has(o)||t.push({positions:o.map(r=>({row:r.row,col:r.col})),direction:"horizontal",shape:"line",type:o[0].type});for(const o of s)c.has(o)||t.push({positions:o.map(r=>({row:r.row,col:r.col})),direction:"vertical",shape:"line",type:o[0].type});return t}function Sn(e){const t=de(e.grid);if(t.length===0)return{...e,isAnimating:!1};const n=e.grid.map(l=>[...l]),s=[];let i=null;for(const l of t){if(l.shape==="L"||l.shape==="T"){const d=l.positions[Math.floor(l.positions.length/2)];i={row:d.row,col:d.col,type:l.type,bonus:"blast"}}else if(l.positions.length>=5){const d=l.positions[Math.floor(l.positions.length/2)];i={row:d.row,col:d.col,type:l.type,bonus:"cross"}}else if(l.positions.length===4){const d=l.positions[Math.floor(l.positions.length/2)];i={row:d.row,col:d.col,type:l.type,bonus:l.direction==="horizontal"?"line_h":"line_v"}}for(const d of l.positions){const u=n[d.row][d.col];u?.bonus&&s.push({row:d.row,col:d.col,bonus:u.bonus})}for(const d of l.positions)n[d.row][d.col]=null}const a=new Set;for(;s.length>0;){const l=s.shift(),d=`${l.row},${l.col}`;if(a.has(d))continue;a.add(d);const u=$n(n,l.row,l.col,l.bonus);for(const p of u){const f=n[p.row]?.[p.col];f?.bonus&&!a.has(`${p.row},${p.col}`)&&s.push({row:p.row,col:p.col,bonus:f.bonus}),n[p.row]&&(n[p.row][p.col]=null)}}i&&n[i.row][i.col]===null&&(n[i.row][i.col]={type:i.type,bonus:i.bonus,row:i.row,col:i.col,id:ye()});const c=t.reduce((l,d)=>l+d.positions.length*10,0),o=1+e.combo*.5,r=e.score+Math.floor(c*o);return{...e,grid:n,score:r,combo:e.combo+1,isAnimating:!0}}function $n(e,t,n,s){const i=[];switch(s){case"line_h":for(let a=0;a<G;a++)e[t][a]&&i.push({row:t,col:a});break;case"line_v":for(let a=0;a<M;a++)e[a][n]&&i.push({row:a,col:n});break;case"cross":for(let a=0;a<G;a++)e[t][a]&&i.push({row:t,col:a});for(let a=0;a<M;a++)e[a][n]&&a!==t&&i.push({row:a,col:n});break;case"blast":for(let a=-1;a<=1;a++)for(let c=-1;c<=1;c++){const o=t+a,r=n+c;o>=0&&o<M&&r>=0&&r<G&&e[o][r]&&i.push({row:o,col:r})}break}return i}function En(e){const t=e.grid.map(n=>[...n]);for(let n=0;n<G;n++){let s=M-1;for(let i=M-1;i>=0;i--)t[i][n]!==null&&(i!==s&&(t[s][n]=t[i][n],t[s][n].row=s,t[i][n]=null),s--)}return{...e,grid:t}}function kn(e){const t=[];let n=!1;for(let s=0;s<G;s++)if(e.grid[0][s]!==null){n=!0;break}if(n)return{...e,isGameOver:!0};for(let s=0;s<M-1;s++)t[s]=e.grid[s+1].map(i=>i?{...i,row:s}:null);return t[M-1]=e.nextRow.map((s,i)=>({...s,row:M-1,col:i})),{...e,grid:t,nextRow:Re(),riseProgress:0}}function Be(e){return e.score>=e.targetScore}function An(e,t){if(e.isGameOver)return e;const n=Math.max(0,e.timeRemaining-t),s=e.riseProgress+t*.1;let i={...e,timeRemaining:n,riseProgress:s};return s>=1&&(i=kn(i)),n<=0&&(i={...i,isGameOver:!0}),i}const ce=pn(),Oe=new URLSearchParams(window.location.search);let W=Oe.get("seed")||ce?.seed||`mystery-${Date.now()}`,E=Le(W),In=Ne(W),qe=en(E,In),b;if(ce&&ce.seed===W)b=xe(ce.state);else{const e=Zt(E);b=xe(e)}Oe.get("seed")||window.history.replaceState({},"",`?seed=${W}`);b.subscribe(e=>{e.phase!=="resolution"&&un(e,W)});let m=null,me=null,X=null,pe=0,he=null,F=!1,ge=0;const Tn=180,xn=350,Cn=300,zn=150;function Nn(e){m=vn(150,45),me=e,pe=performance.now(),ge=0,F=!1,Pn();const t=n=>{if(!m)return;const s=(n-pe)/1e3;if(pe=n,!m.isGameOver&&!F&&(m=An(m,s),Bn(),m.isGameOver)){De();return}X=requestAnimationFrame(t)};X=requestAnimationFrame(t)}function Pn(){if(!m)return;document.querySelector(".puzzle-overlay")?.remove();const e=document.createElement("div");e.className="puzzle-overlay",e.innerHTML=`
    <div class="puzzle-container">
      <div class="puzzle-header">
        <h2>Evidence Search</h2>
        <p>Tap to select, tap adjacent to swap</p>
      </div>

      <div class="puzzle-stats">
        <div class="puzzle-stat">
          <div class="puzzle-stat-label">Score</div>
          <div class="puzzle-stat-value score" id="puzzle-score">0</div>
        </div>
        <div class="puzzle-stat">
          <div class="puzzle-stat-label">Goal</div>
          <div class="puzzle-stat-value target">${m.targetScore}</div>
        </div>
        <div class="puzzle-stat">
          <div class="puzzle-stat-label">Combo</div>
          <div class="puzzle-stat-value combo" id="puzzle-combo">-</div>
        </div>
        <div class="puzzle-stat">
          <div class="puzzle-stat-label">Time</div>
          <div class="puzzle-stat-value time" id="puzzle-time">${Math.ceil(m.timeRemaining)}s</div>
        </div>
      </div>

      <div class="puzzle-progress-row">
        <div class="puzzle-progress score-progress">
          <div class="puzzle-progress-bar" id="puzzle-score-bar" style="width: 0%"></div>
        </div>
        <div class="puzzle-progress time-progress">
          <div class="puzzle-progress-bar time-bar" id="puzzle-time-bar" style="width: 100%"></div>
        </div>
      </div>

      <div class="puzzle-game-area" id="puzzle-game-area">
        <div class="puzzle-grid" id="puzzle-grid"></div>
      </div>

      <div class="puzzle-actions">
        <button class="btn-secondary" id="puzzle-skip">Skip (+1 token)</button>
      </div>

      <div class="puzzle-result-overlay" id="puzzle-result" style="display: none;">
        <div class="puzzle-result">
          <h3 id="puzzle-result-title"></h3>
          <p id="puzzle-result-text"></p>
          <button class="btn-primary" id="puzzle-done">Continue</button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(e),he=e,Y(),document.getElementById("puzzle-skip")?.addEventListener("click",()=>{Ge(1)})}function Y(){if(!m)return;const e=document.getElementById("puzzle-grid");if(!e)return;const t=6,s=m.grid.slice(t).map((i,a)=>{const c=a+t;return i.map((o,r)=>{const l=m.selected?.row===c&&m.selected?.col===r;if(!o)return`<div class="puzzle-cell empty" data-row="${c}" data-col="${r}"></div>`;const d=o.bonus?`<span class="bonus-indicator">${hn[o.bonus]}</span>`:"";return`<div class="${["puzzle-cell",o.type,o.bonus?"has-bonus":"",l?"selected":""].filter(Boolean).join(" ")}" data-row="${c}" data-col="${r}" data-id="${o.id}">${mn[o.type]}${d}</div>`}).join("")}).join("");e.innerHTML=s,e.onclick=Mn,On()}function Mn(e){const n=e.target.closest(".puzzle-cell");if(!n||!m||F)return;const s=parseInt(n.dataset.row),i=parseInt(n.dataset.col);if(!(n.classList.contains("empty")&&!m.selected))if(m.selected){const{row:a,col:c}=m.selected;if(a===s&&c===i){m={...m,selected:null},Q(null);return}const o=Math.abs(a-s),r=Math.abs(c-i);if(o===1&&r===0||o===0&&r===1){const d=wn(m,s,i);d.swapped?(F=!0,Ln(a,c,s,i,()=>{m=d.state,_e()})):(Rn(a,c,s,i),m={...m,selected:null},Q(null))}else m=ze(m,s,i),Q({row:s,col:i})}else n.classList.contains("empty")||(m=ze(m,s,i),Q({row:s,col:i}))}function Q(e){const t=document.getElementById("puzzle-grid");t&&(t.querySelectorAll(".puzzle-cell.selected").forEach(n=>{n.classList.remove("selected")}),e&&t.querySelector(`[data-row="${e.row}"][data-col="${e.col}"]`)?.classList.add("selected"))}function Ln(e,t,n,s,i){const a=document.getElementById("puzzle-grid");if(!a){i();return}const c=a.querySelector(`[data-row="${e}"][data-col="${t}"]`),o=a.querySelector(`[data-row="${n}"][data-col="${s}"]`);if(!c&&!o){i();return}c?.classList.remove("selected"),o?.classList.remove("selected"),e===n?t<s?(c?.classList.add("swapping-right"),o?.classList.add("swapping-left")):(c?.classList.add("swapping-left"),o?.classList.add("swapping-right")):e<n?(c?.classList.add("swapping-down"),o?.classList.add("swapping-up")):(c?.classList.add("swapping-up"),o?.classList.add("swapping-down")),setTimeout(i,Tn)}function Rn(e,t,n,s){const i=document.getElementById("puzzle-grid");if(!i)return;const a=i.querySelector(`[data-row="${e}"][data-col="${t}"]`),c=i.querySelector(`[data-row="${n}"][data-col="${s}"]`);a?.classList.remove("selected"),a?.classList.add("invalid-swap"),c?.classList.add("invalid-swap"),setTimeout(()=>{a?.classList.remove("invalid-swap"),c?.classList.remove("invalid-swap")},400)}function Bn(){if(!m)return;const e=document.getElementById("puzzle-time"),t=document.getElementById("puzzle-time-bar");if(e){const n=Math.ceil(m.timeRemaining);e.textContent=`${n}s`,n<=10?e.classList.add("low"):e.classList.remove("low")}if(t){const n=m.timeRemaining/45*100;t.style.width=`${Math.max(0,n)}%`}}function On(){if(!m)return;const e=document.getElementById("puzzle-score"),t=document.getElementById("puzzle-combo"),n=document.getElementById("puzzle-score-bar");if(e&&(e.textContent=`${m.score}`,m.score>ge&&(e.style.transform="scale(1.2)",setTimeout(()=>{e&&(e.style.transform="scale(1)")},150),ge=m.score)),t&&(m.combo>1?(t.textContent=`x${m.combo}`,t.classList.add("active"),setTimeout(()=>t.classList.remove("active"),300)):t.textContent="-"),n){const s=Math.min(100,m.score/m.targetScore*100);n.style.width=`${s}%`}}function qn(e,t,n){const s=document.getElementById("puzzle-game-area");if(!s)return;const i=document.createElement("div");i.className="puzzle-score-popup",i.textContent=`+${e}`,i.style.left=`${t}px`,i.style.top=`${n}px`,s.appendChild(i),setTimeout(()=>i.remove(),800)}function Dn(e){if(e<2)return;const t=document.getElementById("puzzle-game-area");if(!t)return;const n=document.createElement("div");n.className="puzzle-combo-indicator",n.textContent=`${e}x COMBO!`,t.appendChild(n),setTimeout(()=>n.remove(),600)}function De(){if(!m)return;const e=Be(m),t=document.getElementById("puzzle-result"),n=document.getElementById("puzzle-result-title"),s=document.getElementById("puzzle-result-text"),i=document.getElementById("puzzle-done");if(t&&(t.style.display="flex",t.className=`puzzle-result-overlay ${e?"won":"lost"}`),n&&(n.textContent=e?"Case Cracked!":"Time's Up!"),s){const a=e?3:m.score>=m.targetScore/2?2:1;s.textContent=e?`Excellent detective work! Score: ${m.score}. You earned ${a} search tokens.`:m.score>0?`Score: ${m.score}/${m.targetScore}. You earned ${a} search token${a>1?"s":""}.`:"No matches found. You earned 1 search token."}i&&(i.onclick=()=>{const a=e?3:m&&m.score>=m.targetScore/2?2:1;Ge(a)})}function Ge(e){X&&(cancelAnimationFrame(X),X=null),he?.remove(),he=null,me?.(e),m=null,me=null,F=!1}function _e(){if(!m){F=!1;return}const e=de(m.grid);e.length>0?Gn(e,()=>{if(!m){F=!1;return}const t=m.score;m=Sn(m);const n=m.score-t;if(n>0&&qn(n,150,100),m.combo>1&&Dn(m.combo),Be(m)){m={...m,isGameOver:!0},Y(),setTimeout(()=>De(),500);return}const s=m.grid.map(i=>i.map(a=>!!a));m=En(m),_n(s,()=>{Y(),setTimeout(()=>_e(),zn)})}):(m={...m,combo:0,isAnimating:!1},F=!1,Y())}function Gn(e,t){const n=document.getElementById("puzzle-grid");if(!n){t();return}e.forEach(s=>{s.positions.forEach(({row:i,col:a})=>{const c=n.querySelector(`[data-row="${i}"][data-col="${a}"]`);c&&c.classList.add("clearing")})}),setTimeout(t,xn)}function _n(e,t){if(!m){t();return}Y();const n=document.getElementById("puzzle-grid");if(!n){t();return}let s=!1;const i=m.grid;for(let a=0;a<i.length;a++)for(let c=0;c<i[a].length;c++)if(i[a][c]&&!e[a][c]){const o=n.querySelector(`[data-row="${a}"][data-col="${c}"]`);o&&(o.classList.add("falling"),s=!0)}setTimeout(t,s?Cn:50)}function H(){const e=b.getState(),t=document.getElementById("app");if(t)switch(e.phase){case"intro":N.stopMusic(),Kn(t);break;case"investigation":e.interrogation?(N.playMusic("interrogation"),Wn(t)):(N.playMusic("investigation"),Vn(t));break;case"accusation":N.playMusic("tension"),Qn(t);break;case"resolution":N.playMusic(e.result?.won?"victory":"defeat"),Zn(t);break}}b.subscribe(H);H();document.addEventListener("keydown",e=>{const t=b.getState();if(e.key==="m"||e.key==="M"){N.toggleMusic(),N.toggleSfx(),H();return}switch(t.phase){case"intro":(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),b.dispatch(I.startGame()));break;case"investigation":if(t.interrogation){if(e.key==="ArrowLeft"||e.key==="a"||e.key==="A")b.dispatch(I.previousStatement());else if(e.key==="ArrowRight"||e.key==="d"||e.key==="D")b.dispatch(I.nextStatement());else if(e.key==="p"||e.key==="P"){const n=document.getElementById("press-btn");n&&!n.disabled&&n.click()}else if(e.key==="e"||e.key==="E"){const n=document.getElementById("present-btn");n&&!n.disabled&&n.click()}else if(e.key==="Escape"||e.key==="Backspace"){const n=document.getElementById("evidence-drawer");n&&!n.classList.contains("hidden")?n.classList.add("hidden"):b.dispatch(I.endInterrogation())}else if(e.key>="1"&&e.key<="9"){const n=document.getElementById("evidence-drawer");if(n&&!n.classList.contains("hidden")){const s=n.querySelectorAll(".evidence-select-card"),i=parseInt(e.key)-1;s[i]&&s[i].click()}}}else if(e.key==="1")document.querySelector('[data-tab="suspects"]')?.dispatchEvent(new Event("click"));else if(e.key==="2")document.querySelector('[data-tab="evidence"]')?.dispatchEvent(new Event("click"));else if(e.key==="3")document.querySelector('[data-tab="locations"]')?.dispatchEvent(new Event("click"));else if(e.key==="s"||e.key==="S")document.getElementById("search-btn")?.click();else if(e.key==="Enter"){const n=document.getElementById("accuse-btn");n&&!n.disabled&&n.click()}break;case"accusation":e.key==="Escape"&&b.dispatch(I.cancelAccusation());break;case"resolution":e.key==="Enter"||e.key===" "?(e.preventDefault(),document.getElementById("new-mystery-btn")?.click()):(e.key==="r"||e.key==="R")&&document.getElementById("replay-btn")?.click();break}});function Kn(e){const t=_t(E),n=E.locations.find(s=>s.id===E.crimeScene);e.innerHTML=`
    <div class="intro-screen">
      <header class="header">
        <h1>Black Rabbit</h1>
        <p class="subtitle">A Murder Most Foul</p>
      </header>

      <main class="intro-content">
        <div class="newspaper">
          <h2 class="headline">TRAGEDY STRIKES</h2>
          <div class="newspaper-body">
            <p class="lead">
              <strong>${D(t)}</strong>, ${t.age}, a respected ${t.occupation.toLowerCase()},
              was found dead in the ${n?.name||"manor"} this evening.
            </p>
            <p>${t.description}</p>
            <p>
              The death occurred around <strong>${E.timeOfDeath.label}</strong>.
              Police suspect foul play.
            </p>
            <p class="quote">
              "One of the guests must be responsible," says the inspector.
              "No one leaves until we find the truth."
            </p>
          </div>
        </div>

        <div class="case-info">
          <p>Case File: <code>${W.slice(-8).toUpperCase()}</code></p>
          <p>${ve(E).length} suspects to interrogate</p>
        </div>

        <div class="intro-buttons">
          <button class="btn-primary" id="start-btn">Begin Investigation</button>
          ${fn()?'<button class="btn-secondary" id="new-game-btn">New Mystery</button>':""}
        </div>
      </main>
    </div>
  `,document.getElementById("start-btn")?.addEventListener("click",()=>{b.dispatch(I.startGame())}),document.getElementById("new-game-btn")?.addEventListener("click",()=>{ae(),window.location.href=`?seed=mystery-${Date.now()}`})}function Vn(e){const t=b.getState(),n=ve(E),s=Array.from(t.playerKnowledge.discoveredClues),i=E.clues,a=i.filter(c=>c.foundAt===t.currentLocation&&!t.playerKnowledge.discoveredClues.has(c.id));e.innerHTML=`
    <div class="investigation-screen">
      <header class="game-header">
        <h1>Black Rabbit</h1>
        <div class="header-stats">
          <span class="stat">Evidence: ${s.length}/${i.length}</span>
          <span class="stat">Mistakes: ${t.mistakeCount}/${t.maxMistakes}</span>
          <span class="stat search-tokens" title="Search tokens - play mini-game to earn more">
            <span class="search-tokens-icon">🔍</span>
            <span class="search-tokens-count">${t.searchTokens}</span>
          </span>
          <button class="btn-audio" id="toggle-audio" title="Toggle Sound">
            ${N.isSfxEnabled()?"🔊":"🔇"}
          </button>
        </div>
      </header>

      <nav class="game-nav">
        <button class="nav-btn active" data-tab="suspects">Suspects</button>
        <button class="nav-btn" data-tab="evidence">Evidence</button>
        <button class="nav-btn" data-tab="locations">Locations</button>
      </nav>

      <main class="game-main">
        <section class="tab-content" id="suspects-tab">
          <h2>Suspects</h2>
          <div class="suspect-grid">
            ${n.map(c=>Fn(c,t)).join("")}
          </div>
        </section>

        <section class="tab-content hidden" id="evidence-tab">
          <h2>Collected Evidence</h2>
          ${s.length===0?'<p class="empty-state">No evidence collected yet. Search the locations!</p>':`<div class="evidence-grid">
                ${s.map(c=>{const o=i.find(r=>r.id===c);return o?jn(o):""}).join("")}
              </div>`}
        </section>

        <section class="tab-content hidden" id="locations-tab">
          <h2>Locations</h2>
          <div class="location-grid">
            ${E.locations.map(c=>`
              <div class="card location-card ${c.id===t.currentLocation?"current":""}"
                   data-location="${c.id}">
                <h3>${c.name}</h3>
                <p>${c.description}</p>
                ${c.isCrimeScene?'<span class="badge crime-scene-badge">Crime Scene</span>':""}
                ${t.playerKnowledge.examinedLocations.has(c.id)?'<span class="badge examined-badge">Searched</span>':""}
              </div>
            `).join("")}
          </div>
        </section>
      </main>

      ${a.length>0?`
        <div class="discovery-prompt">
          <p>You notice something in the ${E.locations.find(c=>c.id===t.currentLocation)?.name}...</p>
          ${t.searchTokens>0?`<button class="btn-secondary" id="search-btn">Search Area (🔍 ${t.searchTokens})</button>`:'<button class="btn-primary" id="earn-tokens-btn">Play Mini-Game to Search</button>'}
        </div>
      `:`
        <div class="discovery-prompt" style="border-top-color: var(--smoke-gray);">
          <p>No more evidence at this location.</p>
          <button class="btn-secondary" id="earn-tokens-btn">Play Mini-Game (🔍 +tokens)</button>
        </div>
      `}

      <footer class="game-footer">
        <button class="btn-accuse" id="accuse-btn" ${s.length<3?"disabled":""}>
          Make Accusation
        </button>
      </footer>
    </div>
  `,document.querySelectorAll(".nav-btn").forEach(c=>{c.addEventListener("click",o=>{const r=o.target,l=r.dataset.tab;document.querySelectorAll(".nav-btn").forEach(d=>d.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-content").forEach(d=>d.classList.add("hidden")),document.getElementById(`${l}-tab`)?.classList.remove("hidden")})}),document.querySelectorAll(".suspect-card").forEach(c=>{c.addEventListener("click",o=>{const r=o.currentTarget.dataset.suspect;b.dispatch(I.startInterrogation(r))})}),document.querySelectorAll(".location-card").forEach(c=>{c.addEventListener("click",o=>{const r=o.currentTarget.dataset.location;r&&b.dispatch(I.examineLocation(r))})}),document.getElementById("search-btn")?.addEventListener("click",()=>{const c=b.getState();if(a.length>0&&c.searchTokens>0){b.dispatch(I.spendSearchToken());const o=a[0];b.dispatch(I.discoverClue(o.id)),Hn(o)}}),document.getElementById("earn-tokens-btn")?.addEventListener("click",()=>{Nn(c=>{b.dispatch(I.addSearchTokens(c)),H()})}),document.getElementById("accuse-btn")?.addEventListener("click",()=>{b.dispatch(I.startAccusation())}),document.getElementById("toggle-audio")?.addEventListener("click",()=>{N.toggleSfx(),N.toggleMusic(),H()})}function Fn(e,t){const n=t.playerKnowledge.interrogatedSuspects.has(e.id);return`
    <div class="card suspect-card" data-suspect="${e.id}">
      <h3>${D(e)}</h3>
      <p class="occupation">${e.occupation}, ${e.age}</p>
      <p class="description">${e.description}</p>
      ${n?'<span class="badge interrogated-badge">Questioned</span>':""}
      <div class="card-action">
        <span class="interrogate-hint">Click to interrogate</span>
      </div>
    </div>
  `}function jn(e){const t=E.locations.find(i=>i.id===e.foundAt),n=e.pointsTo?E.suspects.find(i=>i.id===e.pointsTo):null;return`
    <div class="card evidence-card ${e.significance==="critical"?"evidence-critical":e.significance==="minor"?"evidence-minor":""}" data-clue-id="${e.id}">
      <div class="evidence-header">
        <h4>${e.name}</h4>
        ${e.significance==="critical"?'<span class="badge critical-badge">Key Evidence</span>':""}
      </div>
      <p class="evidence-type">${e.type} evidence</p>
      <p class="evidence-description">${e.description}</p>
      <div class="evidence-meta">
        <span class="evidence-location">Found: ${t?.name||"Unknown"}</span>
        ${n?`<span class="evidence-implicates">Implicates: ${n.firstName} ${n.lastName}</span>`:""}
      </div>
    </div>
  `}function Hn(e){N.playSfx("clue_found");const t=document.createElement("div");t.className="modal-overlay",t.innerHTML=`
    <div class="modal clue-discovery-modal">
      <h2>Evidence Discovered!</h2>
      <div class="discovered-clue">
        <h3>${e.name}</h3>
        <p class="evidence-type">${e.type} evidence • ${e.significance}</p>
        <p>${e.description}</p>
      </div>
      <button class="btn-primary" id="close-modal">Add to Evidence</button>
    </div>
  `,document.body.appendChild(t),document.getElementById("close-modal")?.addEventListener("click",()=>{t.remove(),H()})}function Wn(e){const t=b.getState();if(!t.interrogation)return;const n=E.suspects.find(d=>d.id===t.interrogation.suspectId),s=qe.get(n.id),i=t.interrogation.currentStatementIndex,a=s.statements[Math.min(i,s.statements.length-1)],c=t.interrogation.pressedStatements.has(i),o=t.playerKnowledge.revealedContradictions.has(a.id),r=Array.from(t.playerKnowledge.discoveredClues).map(d=>E.clues.find(u=>u.id===d)).filter(Boolean);let l="";o?l="caught":a.isLie&&c?l="nervous":c&&(l="defensive"),e.innerHTML=`
    <div class="interrogation-screen">
      <header class="interrogation-header">
        <button class="btn-back" id="end-interrogation">← Back</button>
        <h2>Interrogating ${D(n)}</h2>
        <span class="mistakes">Mistakes: ${t.mistakeCount}/${t.maxMistakes}</span>
      </header>

      <main class="interrogation-main">
        <div class="suspect-portrait">
          <div class="portrait-placeholder ${l}">
            ${n.firstName[0]}${n.lastName[0]}
          </div>
          <p class="suspect-name">${D(n)}</p>
          <p class="suspect-role">${n.occupation}</p>
        </div>

        <div class="testimony-box">
          <div class="statement-counter">
            Statement ${i+1} of ${s.statements.length}
          </div>

          <div class="statement ${o?"contradicted":""}">
            <p class="statement-text">
              "${c?a.pressResponse:o&&a.truthReveal?a.truthReveal:a.text}"
            </p>
            ${o?'<span class="contradiction-found">CONTRADICTION FOUND!</span>':""}
          </div>

          <div class="testimony-actions">
            <button class="btn-action" id="press-btn" ${c||o?"disabled":""}>
              Press
            </button>
            <button class="btn-action btn-present" id="present-btn" ${o?"disabled":""}>
              Present Evidence
            </button>
          </div>

          <div class="statement-nav">
            <button class="btn-nav" id="prev-stmt" ${i===0?"disabled":""}>
              ← Previous
            </button>
            <button class="btn-nav" id="next-stmt" ${i>=s.statements.length-1?"disabled":""}>
              Next →
            </button>
          </div>
        </div>
      </main>

      <div class="evidence-drawer hidden" id="evidence-drawer">
        <h3>Select Evidence to Present</h3>
        <div class="evidence-select-grid">
          ${r.map((d,u)=>{const p=E.locations.find(v=>v.id===d.foundAt),f=d.pointsTo?E.suspects.find(v=>v.id===d.pointsTo):null;return`
              <div class="evidence-select-card ${d.significance==="critical"?"evidence-select-critical":""}" data-clue="${d.id}">
                <span class="evidence-number">${u+1}</span>
                <h4>${d.name}</h4>
                <p class="evidence-select-type">${d.type} evidence</p>
                <p class="evidence-select-location">Found: ${p?.name||"Unknown"}</p>
                ${f?`<p class="evidence-select-implicates">→ ${f.firstName} ${f.lastName}</p>`:""}
              </div>
            `}).join("")}
        </div>
        <button class="btn-secondary" id="cancel-present">Cancel <kbd>Esc</kbd></button>
      </div>

      <footer class="keyboard-hints">
        <span><kbd>←</kbd><kbd>→</kbd> Navigate</span>
        <span><kbd>P</kbd> Press</span>
        <span><kbd>E</kbd> Evidence</span>
        <span><kbd>Esc</kbd> Back</span>
        <span><kbd>M</kbd> Mute</span>
      </footer>
    </div>
  `,document.getElementById("end-interrogation")?.addEventListener("click",()=>{b.dispatch(I.endInterrogation())}),document.getElementById("press-btn")?.addEventListener("click",()=>{Yn(),setTimeout(()=>{b.dispatch(I.pressStatement())},800)}),document.getElementById("present-btn")?.addEventListener("click",()=>{document.getElementById("evidence-drawer")?.classList.remove("hidden")}),document.getElementById("cancel-present")?.addEventListener("click",()=>{document.getElementById("evidence-drawer")?.classList.add("hidden")}),document.getElementById("prev-stmt")?.addEventListener("click",()=>{b.dispatch(I.previousStatement())}),document.getElementById("next-stmt")?.addEventListener("click",()=>{b.dispatch(I.nextStatement())}),document.querySelectorAll(".evidence-select-card").forEach(d=>{d.addEventListener("click",u=>{const p=u.currentTarget.dataset.clue;p&&(Xn(),setTimeout(()=>{b.dispatch(I.presentEvidence(p,a)),document.getElementById("evidence-drawer")?.classList.add("hidden"),b.getState().playerKnowledge.revealedContradictions.has(a.id)?Jn():Un()},1400))})})}function Un(){N.playSfx("wrong");const e=document.createElement("div");e.className="wrong-flash",e.innerHTML="<span>OBJECTION OVERRULED!</span>",document.body.appendChild(e),setTimeout(()=>e.remove(),1500)}function Xn(){N.playSfx("objection");const e=document.createElement("div");e.className="objection-flash",e.innerHTML='<span class="objection-text">OBJECTION!</span>',document.body.appendChild(e),setTimeout(()=>e.remove(),1500)}function Yn(){N.playSfx("holdit");const e=document.createElement("div");e.className="holdit-flash",e.innerHTML='<span class="holdit-text">HOLD IT!</span>',document.body.appendChild(e),setTimeout(()=>e.remove(),1100)}function Jn(){N.playSfx("contradiction");const e=document.createElement("div");e.className="contradiction-celebration",document.body.appendChild(e),setTimeout(()=>e.remove(),1e3)}function Qn(e){const t=b.getState(),n=ve(E),s=Array.from(t.playerKnowledge.discoveredClues).map(i=>E.clues.find(a=>a.id===i)).filter(Boolean);e.innerHTML=`
    <div class="accusation-screen">
      <header class="header">
        <h1>Make Your Accusation</h1>
      </header>

      <main class="accusation-form">
        <div class="form-group">
          <label>The murderer is:</label>
          <div class="suspect-select">
            ${n.map(i=>`
              <label class="radio-card">
                <input type="radio" name="accused" value="${i.id}">
                <span class="radio-card-content">
                  <strong>${D(i)}</strong>
                  <span>${i.occupation}</span>
                </span>
              </label>
            `).join("")}
          </div>
        </div>

        <div class="form-group">
          <label>The motive was:</label>
          <div class="motive-select">
            ${Object.values(k).map(i=>`
              <label class="radio-card">
                <input type="radio" name="motive" value="${i}">
                <span class="radio-card-content">${i}</span>
              </label>
            `).join("")}
          </div>
        </div>

        <div class="form-group">
          <label>Supporting evidence (select at least 1):</label>
          <div class="evidence-checkboxes">
            ${s.map(i=>`
              <label class="checkbox-card">
                <input type="checkbox" name="evidence" value="${i.id}">
                <span class="checkbox-card-content">
                  <strong>${i.name}</strong>
                  <span>${i.type}</span>
                </span>
              </label>
            `).join("")}
          </div>
        </div>

        <div class="accusation-actions">
          <button class="btn-secondary" id="cancel-accusation">Cancel</button>
          <button class="btn-accuse" id="confirm-accusation">Confirm Accusation</button>
        </div>
      </main>
    </div>
  `,document.getElementById("cancel-accusation")?.addEventListener("click",()=>{b.dispatch(I.cancelAccusation())}),document.getElementById("confirm-accusation")?.addEventListener("click",()=>{const i=document.querySelector('input[name="accused"]:checked'),a=document.querySelector('input[name="motive"]:checked'),c=document.querySelectorAll('input[name="evidence"]:checked');if(!i||!a){alert("Please select a suspect and motive.");return}const o=Array.from(c).map(r=>r.value);b.dispatch(I.setAccusation({accusedId:i.value,motive:a.value,supportingEvidence:o})),b.dispatch(I.confirmAccusation(qe))})}function Zn(e){const t=b.getState(),n=t.result,s=E.suspects.find(a=>a.id===n.correctKiller),i=E.suspects.find(a=>a.id===n.playerAccused);ae(),e.innerHTML=`
    <div class="resolution-screen ${n.won?"won":"lost"}">
      <header class="resolution-header">
        <h1>${n.won?"CASE SOLVED":"CASE UNSOLVED"}</h1>
      </header>

      <main class="resolution-content">
        ${n.won?`
          <div class="victory-message">
            <p class="result-text">You correctly identified the murderer!</p>
            <div class="killer-reveal">
              <h2>${D(s)}</h2>
              <p>${s.occupation}</p>
              <p>Motive: <strong>${E.motive}</strong></p>
              <p>Weapon: <strong>${E.weapon}</strong></p>
            </div>
          </div>
        `:`
          <div class="defeat-message">
            <p class="result-text">You accused the wrong person.</p>
            <div class="wrong-accusation">
              <p>You accused: <strong>${D(i)}</strong></p>
              <p>The real killer was: <strong>${D(s)}</strong></p>
            </div>
            <div class="killer-reveal">
              <h2>The Truth</h2>
              <p>${D(s)} committed the murder.</p>
              <p>Motive: <strong>${E.motive}</strong></p>
              <p>Weapon: <strong>${E.weapon}</strong></p>
            </div>
          </div>
        `}

        <div class="stats">
          <h3>Your Investigation</h3>
          <ul>
            <li>Evidence found: ${n.cluesFound} / ${n.totalClues}</li>
            <li>Contradictions revealed: ${n.contradictionsFound} / ${n.totalContradictions}</li>
            <li>Mistakes made: ${t.mistakeCount}</li>
          </ul>
        </div>

        <div class="resolution-actions">
          <button class="btn-primary" id="new-mystery-btn">New Mystery</button>
          <button class="btn-secondary" id="replay-btn">Replay This Case</button>
        </div>
      </main>
    </div>
  `,document.getElementById("new-mystery-btn")?.addEventListener("click",()=>{ae(),window.location.href=`?seed=mystery-${Date.now()}`}),document.getElementById("replay-btn")?.addEventListener("click",()=>{ae(),window.location.reload()})}
